// app/Components/Css/FarmInfo/WeatherAPI.js
import axios from 'axios';
import { WEATHER_API_KEY_PORTAL, WEATHER_API_KEY_KMA } from '../../API/apikey';
import { XMLParser } from 'fast-xml-parser';

// XML íŒŒì„œ ì„¤ì •
const parser = new XMLParser();

// ê³µí†µ API ìš”ì²­ í•¨ìˆ˜
const fetchAPI = async (url, params, useKmaKey = false) => {
  try {
    const finalParams = {
      ...params,
      ...(url.includes('data.go.kr')
        ? { serviceKey: WEATHER_API_KEY_PORTAL }
        : { authKey: WEATHER_API_KEY_KMA }),
    };

    const response = await axios.get(url, { params: finalParams });
    const xml = response.data;
    console.log('[LOG] ë‚ ì”¨ API ì› ì‘ë‹µ:', xml);
    const json = parser.parse(xml);
    return json;
  } catch (error) {
    console.error('[ERROR] ê¸°ìƒì²­ API ìš”ì²­ ì˜¤ë¥˜:', error);
    return null;
  }
};

// í†µí•© í˜¸ì¶œ í•¨ìˆ˜
export const fetchWeather = async (type, params) => {
  switch (type) {
    case 'ultraNcst':
      return await fetchUltraSrtNcst(params);
    case 'ultraFcst':
      return await fetchUltraSrtFcst(params);
    case 'vilageFcst':
      return await fetchVilageFcst(params);
    case 'midLandFcst':
      return await fetchMidLandFcst(params);
    case 'midTa':
      return await fetchMidTa(params);
    case 'warning':
      return await fetchWarningNow();
    case 'typhoon':
      return await fetchTyphoon(params);
    case 'latlon': {
      const { lat, lon } = params || {};
      if (lat === undefined || lon === undefined) {
        console.error('[ERROR] ê²©ì ë³€í™˜ íŒŒë¼ë¯¸í„° ëˆ„ë½');
        return null;
      }
      return await convertLatLonToGrid({ lat, lon });
    }
    default:
      console.error('[ERROR] ì•Œ ìˆ˜ ì—†ëŠ” ìš”ì²­ ìœ í˜•:', type);
      return null;
  }
};

// ì´ˆë‹¨ê¸°ì‹¤í™©ì¡°íšŒ
export const fetchUltraSrtNcst = async ({ nx, ny, base_date, base_time }) => {
  return await fetchAPI('https://apis.data.go.kr/1360000/VilageFcstInfoService_2.0/getUltraSrtNcst', {
    pageNo: 1,
    numOfRows: 1000,
    dataType: 'XML',
    base_date,
    base_time,
    nx,
    ny,
  });
};

// ì´ˆë‹¨ê¸°ì˜ˆë³´ì¡°íšŒ
export const fetchUltraSrtFcst = async ({ nx, ny, base_date, base_time }) => {
  return await fetchAPI('https://apis.data.go.kr/1360000/VilageFcstInfoService_2.0/getUltraSrtFcst', {
    pageNo: 1,
    numOfRows: 1000,
    dataType: 'XML',
    base_date,
    base_time,
    nx,
    ny,
  });
};

// ë‹¨ê¸°ì˜ˆë³´ì¡°íšŒ
export const fetchVilageFcst = async ({ nx, ny, base_date, base_time }) => {
  return await fetchAPI('https://apis.data.go.kr/1360000/VilageFcstInfoService_2.0/getVilageFcst', {
    pageNo: 1,
    numOfRows: 1000,
    dataType: 'XML',
    base_date,
    base_time,
    nx,
    ny,
  });
};

// ì¤‘ê¸°ìœ¡ìƒì˜ˆë³´
export const fetchMidLandFcst = async ({ regId, tmFc }) => {
  return await fetchAPI('https://apis.data.go.kr/1360000/MidFcstInfoService/getMidLandFcst', {
    dataType: 'XML',
    regId,
    tmFc,
  });
};

// ì¤‘ê¸°ê¸°ì˜¨ì˜ˆë³´
export const fetchMidTa = async ({ regId, tmFc }) => {
  return await fetchAPI('https://apis.data.go.kr/1360000/MidFcstInfoService/getMidTa', {
    dataType: 'XML',
    regId,
    tmFc,
  });
};

// ê¸°ìƒíŠ¹ë³´
export const fetchWarningNow = async () => {
  return await fetchAPI('https://apihub.kma.go.kr/api/typ01/url/wrn_now_data.php', {
    fe: 'f',
  }, true);
};

// íƒœí’ì •ë³´
export const fetchTyphoon = async ({ YY, typ, seq, mode }) => {
  return await fetchAPI('https://apihub.kma.go.kr/api/typ01/url/typ_data.php', {
    YY,
    typ,
    seq,
    mode,
  }, true);
};

// ìœ„ê²½ë„ â†’ ê²©ìë³€í™˜
export const convertLatLonToGrid = async ({ lat, lon }) => {
  try {
    console.log('[LOG] ëª¨ë“œ: latlon');
    console.log('[LOG] ê²©ì ë³€í™˜ ìš”ì²­ ì¢Œí‘œ:', { lat, lon });

    const response = await axios.get('https://apihub.kma.go.kr/api/typ01/cgi-bin/url/nph-dfs_xy_lonlat', {
      params: {
        lat,
        lon,
        authKey: WEATHER_API_KEY_KMA,
      },
    });

    const text = response.data;
    const match = text.match(/\s+(\d+\.\d+),\s+(\d+\.\d+),\s+(\d+),\s+(\d+)/);

    if (match) {
      const result = {
        lon: parseFloat(match[1]),
        lat: parseFloat(match[2]),
        x: parseInt(match[3]),
        y: parseInt(match[4]),
      };
      console.log('[LOG] ê²©ì ì •ë³´:', result);
      return result;
    } else {
      console.error('[ERROR] ê²©ì ì •ë³´ ì—†ìŒ.');
      return null;
    }
  } catch (error) {
    console.error('[ERROR] ê²©ì ë³€í™˜ ìš”ì²­ ì˜¤ë¥˜:', error);
    return null;
  }
};

ê°€ì¥ ë ë»”í•œ ì½”ë“œ Weather.js

// app/FarmInfo/index.js
import React, { useEffect, useState } from 'react';
import { View, Text, Button, ScrollView } from 'react-native';
import styles from '../Components/Css/FarmInfo/index.js';
import { fetchWeather } from '../Components/Css/FarmInfo/WeatherAPI';
import { getBaseDateTime } from '../Components/Utils/timeUtils';
import * as Location from 'expo-location'; // Expo Location API ì‚¬ìš©

const FARM_COORDS = {
  latitude: 36.953862288,
  longitude: 127.681782599,
  //ìš°ë¦¬ì§‘ ìŒì„±
};

export default function FarmInfo() {
  const [mode, setMode] = useState('farm');
  const [weatherData, setWeatherData] = useState(null);
  const [weeklyData, setWeeklyData] = useState(null);
  const [warningData, setWarningData] = useState('');
  const [loading, setLoading] = useState(false);

  const loadWeather = async () => {
    setLoading(true);
    let coords = FARM_COORDS;
    console.log('[ê³µí†µ] í˜„ì¬ ì„¤ì •ëœ ë†ì¥ ì¢Œí‘œ:', coords);

    if (mode === 'current') {
      try {
        const { status } = await Location.requestForegroundPermissionsAsync();
        if (status !== 'granted') {
          console.error('[ê³µí†µ] ìœ„ì¹˜ ê¶Œí•œ ê±°ë¶€ë¨');
          setLoading(false);
          return;
        }

        const position = await Location.getCurrentPositionAsync({});
        coords = {
          latitude: position.coords.latitude,
          longitude: position.coords.longitude,
        };
        console.log('[ê³µí†µ] í˜„ì¬ ìœ„ì¹˜ ì¢Œí‘œ:', coords);
      } catch (error) {
        console.error('[ê³µí†µ] í˜„ì¬ ìœ„ì¹˜ ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨:', error);
        setLoading(false);
        return;
      }
    }

    const { base_date, base_time } = getBaseDateTime();
    console.log('[ê³µí†µ] ê¸°ì¤€ ë‚ ì§œ ë° ì‹œê°„:', base_date, base_time);

    const grid = await fetchWeather('latlon', {
      lat: coords.latitude,
      lon: coords.longitude,
    });
    console.log('[ê²©ìë³€í™˜] ê²°ê³¼:', grid);
    if (!grid || !grid.x || !grid.y) {
      setLoading(false);
      return;
    }

    console.log('[ì‹œê°„ëŒ€ë³„ ë‚ ì”¨] ìš”ì²­ ì¢Œí‘œ:', grid.x, grid.y);
    const forecast = await fetchWeather('ultraFcst', {
      nx: grid.x,
      ny: grid.y,
      base_date,
      base_time,
    });
    console.log('[ì‹œê°„ëŒ€ë³„ ë‚ ì”¨] ì‘ë‹µ:', forecast);

    const midForecast = grid.midLandId && grid.tmFc ? await fetchWeather('midLandFcst', {
      regId: grid.midLandId,
      tmFc: grid.tmFc,
    }) : null;
    console.log('[ì£¼ê°„ ë‚ ì”¨] ì‘ë‹µ:', midForecast);

    const warning = await fetchWeather('warning');
    console.log('[ê¸°ìƒ íŠ¹ë³´] ì‘ë‹µ:', warning);

    if (forecast) setWeatherData(forecast);
    if (midForecast) setWeeklyData(midForecast);
    if (typeof warning === 'string') setWarningData(warning);

    setLoading(false);
  };

  useEffect(() => {
    loadWeather();
  }, [mode]);

  const getEmojiForPty = (value) => {
    switch (value) {
      case '0': return 'â˜€ ';
      case '1': return 'ğŸŒ§ ';
      case '2': return 'ğŸŒ¦ ';
      case '3': return 'â„ ';
      case '4': return 'ğŸŒ¨ ';
      default: return 'â˜ ';
    }
  };

  const getEmojiForSky = (value) => {
    switch (value) {
      case '1': return 'â˜€ ';
      case '3': return 'â›… ';
      case '4': return 'â˜ ';
      default: return 'â˜ ';
    }
  };

  const renderForecast = () => {
    const msg = weatherData?.response?.header?.resultMsg;
    const code = weatherData?.response?.header?.resultCode;
    if (msg !== 'NORMAL_SERVICE') return <Text style={styles.errorText}>ì—ëŸ¬: {msg} (ì½”ë“œ {code})</Text>;

    const items = weatherData?.response?.body?.items?.item || [];
    const categories = ['PTY', 'RN1', 'SKY', 'T1H', 'REH'];
    const grouped = {};

    for (const item of items) {
      if (!categories.includes(item.category)) continue;
      if (!grouped[item.fcstTime]) grouped[item.fcstTime] = {};
      grouped[item.fcstTime][item.category] = item.fcstValue;
    }

    console.log('[ì‹œê°„ëŒ€ë³„ ë‚ ì”¨] ê·¸ë£¹í™”ëœ ë°ì´í„°:', grouped);

    return Object.entries(grouped).map(([time, data], idx) => {
      const pty = data['PTY'];
      const rn1 = data['RN1'];
      const sky = data['SKY'];
      const t1h = data['T1H'];
      const reh = data['REH'];
      const emoji = pty !== '0' ? getEmojiForPty(pty) : getEmojiForSky(sky);
      const rainInfo = (pty !== '0' && rn1 !== 'ê°•ìˆ˜ì—†ìŒ') ? `${rn1} ` : '';
      const temp = t1h ? `${t1h} â„ƒ ` : '';
      const humidity = reh ? `${reh}%` : '';
      const hour = `${String(time).padStart(4, '0').slice(0, 2)}ì‹œ`;

      return (
        <View key={idx} style={styles.row}>
          <Text style={styles.time}>{hour}</Text>
          <Text style={styles.value}>{emoji}</Text>
          <Text style={styles.value}>{rainInfo}</Text>
          <Text style={styles.value}>{temp}</Text>
          <Text style={styles.value}>{humidity}</Text>
        </View>
      );
    });
  };

  const renderWeekly = () => {
    const items = weeklyData?.response?.body?.items?.item || [];
    const filtered = items.filter(item => item.wfAm && item.wfPm);
    console.log('[ì£¼ê°„ ë‚ ì”¨] í•„í„°ë§ëœ ë°ì´í„°:', filtered);
    if (filtered.length === 0) return <Text style={styles.noWarning}>ì£¼ê°„ ì˜ˆë³´ ë°ì´í„° ì—†ìŒ</Text>;

    const getEmoji = (text) => {
      if (text.includes('ë§‘')) return 'â˜€';
      if (text.includes('êµ¬ë¦„ë§')) return 'â›…';
      if (text.includes('íë¦¼')) return 'â˜';
      if (text.includes('ë¹„')) return 'ğŸŒ§';
      if (text.includes('ëˆˆ')) return 'â„';
      return 'â“';
    };

    return filtered.map((item, idx) => (
      <View key={idx} style={styles.row}>
        <Text style={styles.time}>{item.fcstDate}</Text>
        <Text style={styles.value}>{getEmoji(item.wfAm)} / {getEmoji(item.wfPm)}</Text>
        <Text style={styles.value}>{item.wfAm} / {item.wfPm}</Text>
      </View>
    ));
  };

  const renderWarning = () => {
    const lines = typeof warningData === 'string'
      ? warningData.split('\n').filter(line => line.startsWith('L'))
      : [];
    console.log('[ê¸°ìƒ íŠ¹ë³´] íŒŒì‹±ëœ íŠ¹ë³´ ë¼ì¸:', lines);
    if (lines.length === 0) return <Text style={styles.noWarning}>í˜„ì¬ ë°œíš¨ ì¤‘ì¸ íŠ¹ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.</Text>;
    return lines.map((line, idx) => <Text key={idx} style={styles.warningLine}>{line}</Text>);
  };

  return (
    <ScrollView style={styles.container}>
      <View style={styles.tabContainer}>
        <Button title="ë‚´ ë†ì¥ ë‚ ì”¨" onPress={() => setMode('farm')} />
        <Button title="í˜„ ìœ„ì¹˜ ë‚ ì”¨" onPress={() => setMode('current')} />
      </View>

      <View style={styles.weatherBox}>
        <Text style={styles.sectionTitle}>[ì‹œê°„ëŒ€ë³„ ë‚ ì”¨]</Text>
        {loading ? (
          <Text style={styles.loading}>ë¡œë”©ì¤‘...</Text>
        ) : (
          renderForecast()
        )}
      </View>

      <View style={styles.weatherBox}>
        <Text style={styles.sectionTitle}>[ì£¼ê°„ ë‚ ì”¨]</Text>
        {loading ? (
          <Text style={styles.loading}>ë¡œë”©ì¤‘...</Text>
        ) : (
          renderWeekly()
        )}
      </View>

      <View style={styles.weatherBox}>
        <Text style={styles.sectionTitle}>[ê¸°ìƒ íŠ¹ë³´]</Text>
        {loading ? (
          <Text style={styles.loading}>ë¡œë”©ì¤‘...</Text>
        ) : (
          renderWarning()
        )}
      </View>
    </ScrollView>
  );
}
