import React, { useState, useEffect } from 'react';
import { View, Text, TouchableOpacity, TextInput, Modal, ScrollView, StyleSheet, Alert } from 'react-native';
import AsyncStorage from '@react-native-async-storage/async-storage';
import { useNavigation, useRoute } from '@react-navigation/native';
import { styles } from '../Components/Css/FarmInfo/MarketPriceStyle';
import { getTodayWeather } from '../Components/Utils/weatherUtils';

// Ïù∏Í∏∞ÏûëÎ¨º Î¶¨Ïä§Ìä∏ (MarketPriceScreenÏóêÏÑú Î≥µÏÇ¨)
const popularCrops = [
  { name: 'Î≤º', icon: 'üåæ' }, { name: 'Î∞∞Ï∂î', icon: 'ü•¨' }, { name: 'ÏñëÌåå', icon: 'üßÖ' },
  { name: 'Í∞êÏûê', icon: 'ü•î' }, { name: 'ÏÇ¨Í≥º', icon: 'üçé' }, { name: 'Í≥†Ï∂î', icon: 'üå∂Ô∏è' },
  { name: 'ÎßàÎäò', icon: 'üßÑ' }, { name: 'Î∞∞', icon: 'üçê' }, { name: 'Í≥†Íµ¨Îßà', icon: 'üç†' },
  { name: 'ÏàòÎ∞ï', icon: 'üçâ' }, { name: 'Ìè¨ÎèÑ', icon: 'üçá' }, { name: 'Ïò•ÏàòÏàò', icon: 'üåΩ' },
  { name: 'ÌÜ†ÎßàÌÜ†', icon: 'üçÖ' }, { name: 'Ïò§Ïù¥', icon: 'ü•í' }, { name: 'Í∞ÄÏßÄ', icon: 'üçÜ' },
  { name: 'Î≥µÏà≠ÏïÑ', icon: 'üçë' }, { name: 'Îî∏Í∏∞', icon: 'üçì' }, { name: 'ÎïÖÏΩ©', icon: 'ü•ú' },
  { name: 'Î≤ÑÏÑØ', icon: 'üçÑ' }, { name: 'ÎãπÍ∑º', icon: 'ü•ï' }, { name: 'ÎßùÍ≥†', icon: 'ü•≠' },
];

const weekDays = ['Ïùº', 'Ïõî', 'Ìôî', 'Ïàò', 'Î™©', 'Í∏à', 'ÌÜ†'];

// ÎÇ†Ïßú ÌååÏã± Î≥¥Ï†ï Ìï®Ïàò Ï∂îÍ∞Ä
function parseDiaryDate(date) {
  if (!date) return new Date();
  if (typeof date === 'string') {
    if (date.includes('T')) {
      // ISO Ìè¨Îß∑
      return new Date(date);
    } else if (date.match(/^\d{4}\.\d{1,2}\.\d{1,2}$/)) {
      // Ï†ê(.)Ìè¨Îß∑ ‚Üí ÌïòÏù¥Ìîà(-)ÏúºÎ°ú Î≥ÄÌôò ÌõÑ new Date
      return new Date(date.replace(/\./g, '-'));
    }
  }
  // Í∑∏ Ïô∏: Ïò§Îäò ÎÇ†Ïßú
  return new Date();
}

export default function DiaryWrite() {
  const navigation = useNavigation();
  const route = useRoute();
  const { editMode, diaryData, diaryIndex } = route.params || {};
  const [phoneState, setPhoneState] = useState(null);
  
  // phone Í∞í Ï¥àÍ∏∞Ìôî
  useEffect(() => {
    const loadPhone = async () => {
      try {
        const userStr = await AsyncStorage.getItem('user');
        if (userStr) {
          const user = JSON.parse(userStr);
          if (user && user.phone) {
            setPhoneState(user.phone);
            console.log('DiaryWriteÏóêÏÑú Î∂àÎü¨Ïò® phone:', user.phone);
          }
        }
      } catch (e) {
        console.error('phone Î∂àÎü¨Ïò§Í∏∞ Ïã§Ìå®:', e);
      }
    };
    loadPhone();
  }, []);

  // ÎÇ†Ïßú ÌååÏã± Î≥¥Ï†ï Ï†ÅÏö©
  const [selectedDate, setSelectedDate] = useState(editMode ? parseDiaryDate(diaryData.date) : new Date());
  const [calendarModal, setCalendarModal] = useState(false);
  const [modalVisible, setModalVisible] = useState(false);
  const [searchText, setSearchText] = useState('');
  const [selectedCrop, setSelectedCrop] = useState(null);
  const [varietyList, setVarietyList] = useState([]);
  const [selectedVariety, setSelectedVariety] = useState(editMode ? diaryData.crop : null);
  const [content, setContent] = useState(editMode ? diaryData.content : '');
  const [weather, setWeather] = useState(editMode ? diaryData.weather : '');
  const [itemCodeData, setItemCodeData] = useState([]);

  useEffect(() => {
    // itemCodeDataÎ•º ÎπÑÎèôÍ∏∞Ï†ÅÏúºÎ°ú Î°úÎìú
    const loadItemCodeData = async () => {
      try {
        const data = await import('../Components/Utils/item_code_data.json');
        setItemCodeData(data.default || []);
      } catch (error) {
        console.error('ÏûëÎ¨º Îç∞Ïù¥ÌÑ∞ Î°úÎî© Ïã§Ìå®:', error);
        Alert.alert('Ïò§Î•ò', 'ÏûëÎ¨º Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨Ïò§ÎäîÎç∞ Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
      }
    };
    loadItemCodeData();
  }, []);

  // ÏÉÅÎã® Ìó§Îçî: ‚Üê Îí§Î°úÍ∞ÄÍ∏∞ + Ï§ëÏïô ÌÉÄÏù¥ÌãÄ
  const renderHeader = () => (
    <View style={{ flexDirection: 'row', alignItems: 'center', justifyContent: 'center', height: 56, marginBottom: 8 }}>
      <TouchableOpacity onPress={() => navigation.goBack()} style={{ position: 'absolute', left: 0, paddingLeft: 8, zIndex: 2 }}>
        <Text style={{ fontSize: 28, color: '#222', fontWeight: 'bold' }}>‚Üê</Text>
      </TouchableOpacity>
      <View style={{ flex: 1, alignItems: 'center', justifyContent: 'center' }}>
        <Text style={{ fontSize: 22, fontWeight: 'bold', textAlign: 'center' }}>ÏùºÏßÄ ÏûëÏÑ±ÌïòÍ∏∞</Text>
      </View>
    </View>
  );

  // MarketPriceScreen Îã¨Î†• UI Î≥µÏ†ú
  const renderCalendar = () => {
    const today = new Date();
    const year = selectedDate.getFullYear();
    const month = selectedDate.getMonth();
    const date = selectedDate.getDate();
    const dayOfWeek = selectedDate.getDay();
    const startOfWeek = new Date(selectedDate);
    startOfWeek.setDate(date - dayOfWeek);
    const weekDates = Array.from({ length: 7 }, (_, i) => {
      const d = new Date(startOfWeek);
      d.setDate(startOfWeek.getDate() + i);
      return d;
    });
    return (
      <View style={{ flexDirection: 'row', alignItems: 'center', marginVertical: 10, paddingHorizontal: 16 }}>
        <View style={{ width: 10 }} />
        <TouchableOpacity onPress={() => setCalendarModal(true)} style={{ flexDirection: 'row', alignItems: 'center', marginRight: 10 }}>
          <Text style={{ fontSize: 22, fontWeight: 'bold' }}>{month + 1}Ïõî ‚ñº</Text>
        </TouchableOpacity>
        <View style={{ flex: 1 }}>
          <View style={{ flexDirection: 'row', justifyContent: 'space-between', marginBottom: 4 }}>
            {weekDays.map((w, i) => (
              <Text key={i} style={{ color: i === 0 ? '#FF0000' : i === 6 ? '#0000FF' : '#222', fontWeight: 'bold', fontSize: 16, textAlign: 'center', flex: 1 }}>{w}</Text>
            ))}
          </View>
          <View style={{ flexDirection: 'row', justifyContent: 'space-between', marginBottom: 2 }}>
            {weekDates.map((d, di) => {
              const dayIdx = d.getDay();
              const isToday = d.toDateString() === today.toDateString();
              const isSelected = d.toDateString() === selectedDate.toDateString();
              const isCurrentMonth = d.getMonth() === month;
              return (
                <View key={di} style={{ flex: 1, alignItems: 'center' }}>
                  <TouchableOpacity
                    style={{
                      borderWidth: isToday ? 2 : 0,
                      borderColor: isToday ? '#000' : 'transparent',
                      backgroundColor: isSelected ? '#000' : 'transparent',
                      borderRadius: 8,
                      width: 32, height: 32, alignItems: 'center', justifyContent: 'center',
                    }}
                    onPress={() => setSelectedDate(new Date(d))}
                  >
                    <Text style={{
                      color: isSelected ? '#fff' : (isCurrentMonth ? (dayIdx === 0 ? '#FF0000' : dayIdx === 6 ? '#0000FF' : '#222') : '#bbb'),
                      fontWeight: isSelected ? 'bold' : 'normal',
                      fontSize: 18
                    }}>{d.getDate()}</Text>
                  </TouchableOpacity>
                </View>
              );
            })}
          </View>
        </View>
        <View style={{ width: 10 }} />
      </View>
    );
  };

  // MarketPriceScreen Îã¨Î†• Î™®Îã¨ Î≥µÏ†ú
  const renderCalendarModal = () => {
    const year = selectedDate.getFullYear();
    const month = selectedDate.getMonth();
    const firstDay = new Date(year, month, 1).getDay();
    const lastDate = new Date(year, month + 1, 0).getDate();
    let days = [];
    for (let i = 0; i < firstDay; i++) days.push(null);
    for (let d = 1; d <= lastDate; d++) days.push(d);
    while (days.length % 7 !== 0) days.push(null);
    const weeks = [];
    for (let i = 0; i < days.length; i += 7) weeks.push(days.slice(i, i + 7));
    const today = new Date();
    return (
      <Modal visible={calendarModal} transparent animationType="fade" onRequestClose={() => setCalendarModal(false)}>
        <View style={{ flex:1, justifyContent:'center', alignItems:'center', backgroundColor:'rgba(0,0,0,0.2)' }}>
          <View style={{ backgroundColor: '#fff', borderRadius: 20, padding: 28, width: 350, alignItems: 'center' }}>
            <View style={{ flexDirection: 'row', alignItems: 'center', marginBottom: 10, width: '100%' }}>
              <TouchableOpacity style={{ width: 44, alignItems: 'center', justifyContent: 'center' }} onPress={() => {
                const prevMonth = new Date(year, month - 1, selectedDate.getDate());
                setSelectedDate(prevMonth);
              }}>
                <Text style={{ fontSize: 28, textAlign: 'center' }}>‚óÄ</Text>
              </TouchableOpacity>
              <Text style={{ flex: 1, fontSize: 26, fontWeight: 'bold', textAlign: 'center' }}>{year}ÎÖÑ {month + 1}Ïõî</Text>
              <TouchableOpacity style={{ width: 44, alignItems: 'center', justifyContent: 'center' }} onPress={() => {
                const nextMonth = new Date(year, month + 1, selectedDate.getDate());
                setSelectedDate(nextMonth);
              }}>
                <Text style={{ fontSize: 28, textAlign: 'center' }}>‚ñ∂</Text>
              </TouchableOpacity>
            </View>
            <View style={{ width: '100%', display: 'flex', justifyContent: 'center', alignItems: 'center', marginBottom: 16 }}>
              <View style={{ flexDirection: 'row', justifyContent: 'center' }}>
                {weekDays.map((w, i) => (
                  <Text key={i} style={{ color: i === 0 ? '#FF0000' : i === 6 ? '#0000FF' : '#222', fontWeight: 'bold', fontSize: 20, textAlign: 'center', width: 44 }}>{w}</Text>
                ))}
              </View>
            </View>
            {weeks.map((week, wi) => (
              <View key={wi} style={{ flexDirection: 'row', justifyContent: 'center', marginBottom: 4 }}>
                {week.map((d, di) => {
                  if (d === null) {
                    return <View key={di} style={{ width: 44, height: 44 }} />;
                  }
                  const dateObj = new Date(year, month, d);
                  const isToday = dateObj.toDateString() === today.toDateString();
                  const isSelected = dateObj.toDateString() === selectedDate.toDateString();
                  return (
                    <View key={di} style={{ width: 44, height: 44, alignItems: 'center', justifyContent: 'center' }}>
                      <TouchableOpacity
                        style={{
                          borderWidth: isToday ? 2 : 0,
                          borderColor: isToday ? '#000' : 'transparent',
                          backgroundColor: isSelected ? '#000' : 'transparent',
                          borderRadius: 12,
                          width: 44, height: 44, alignItems: 'center', justifyContent: 'center',
                        }}
                        onPress={() => { setSelectedDate(new Date(year, month, d)); setCalendarModal(false); }}
                      >
                        <Text style={{
                          color: isSelected ? '#fff' : (di === 0 ? '#FF0000' : di === 6 ? '#0000FF' : '#222'),
                          fontWeight: isSelected ? 'bold' : 'normal',
                          fontSize: 22,
                          textAlign: 'center'
                        }}>{d}</Text>
                      </TouchableOpacity>
                    </View>
                  );
                })}
              </View>
            ))}
            <TouchableOpacity style={{ marginTop: 16, backgroundColor: '#eee', borderRadius: 8, padding: 12, width: '100%' }} onPress={() => setCalendarModal(false)}>
              <Text style={{ fontSize: 22, textAlign: 'center' }}>Îã´Í∏∞</Text>
            </TouchableOpacity>
          </View>
        </View>
      </Modal>
    );
  };

  // MarketPriceScreen ÏûëÎ¨ºÏ∂îÍ∞Ä Î≤ÑÌäº/Î™®Îã¨/Í≤ÄÏÉâ/Ïù∏Í∏∞ÏûëÎ¨º/ÌíàÏ¢ÖÎ¶¨Ïä§Ìä∏/Î™®Îã¨Ìó§Îçî Î≥µÏ†ú
  const openModal = () => {
    setModalVisible(true);
    setSearchText('');
    setSelectedCrop(null);
    setVarietyList([]);
  };
  const closeModal = () => {
    setModalVisible(false);
    setSearchText('');
    setSelectedCrop(null);
    setVarietyList([]);
  };
  const handlePopularCropSelect = (crop) => {
    setSearchText(crop.name);
    setSelectedCrop(crop.name);
    const filtered = itemCodeData.filter(item => item.itemName === crop.name);
    const uniqueVarieties = Array.from(new Set(filtered.map(item => item.varietyName)));
    setVarietyList(uniqueVarieties.map(v => `${crop.name} | ${v}`));
  };
  useEffect(() => {
    if (searchText === '') {
      setVarietyList([]);
      setSelectedCrop(null);
      return;
    }
    const filtered = itemCodeData.filter(
      (item) => (item.itemName && item.itemName.includes(searchText)) || (item.varietyName && item.varietyName.includes(searchText))
    );
    const uniquePairs = Array.from(new Set(filtered.map(item => `${item.itemName} | ${item.varietyName}`)));
    setVarietyList(uniquePairs);
    const cropMatch = filtered.find(item => item.itemName && item.itemName.includes(searchText));
    setSelectedCrop(cropMatch ? cropMatch.itemName : null);
  }, [searchText]);
  const handleVarietySelect = (varietyPair) => {
    setSelectedVariety(varietyPair);
    setModalVisible(false);
  };
  const renderModalHeader = () => (
    <>
      <View style={{ height: 16 }} />
      <View style={{ flexDirection: 'row', alignItems: 'center', justifyContent: 'center', marginBottom: 8 }}>
        <TouchableOpacity onPress={closeModal} style={{ position: 'absolute', left: 0, padding: 8 }}>
          <Text style={{ color: '#4A90E2', fontSize: 28, fontWeight: 'bold' }}>‚Üê</Text>
        </TouchableOpacity>
        <Text style={{ fontSize: 24, fontWeight: 'bold', textAlign: 'center' }}>ÏûëÎ¨º Ï∂îÍ∞Ä</Text>
      </View>
    </>
  );
  const renderPopularCrops = () => (
    <>
      <Text style={{ fontSize: 18, fontWeight: 'bold', marginTop: 16, marginBottom: 8, textAlign: 'left' }}>Ïù∏Í∏∞ÏûëÎ¨º TOP 21</Text>
      <ScrollView style={{ maxHeight: 320 }}>
        <View style={{ flexDirection: 'row', flexWrap: 'wrap', justifyContent: 'flex-start' }}>
          {popularCrops.map((crop, idx) => (
            <TouchableOpacity
              key={crop.name}
              style={{
                width: '30%',
                margin: '1.5%',
                backgroundColor: '#f5f5f5',
                borderRadius: 16,
                alignItems: 'center',
                paddingVertical: 18,
                paddingHorizontal: 0,
                minWidth: 90,
                maxWidth: 120,
              }}
              onPress={() => handlePopularCropSelect(crop)}
            >
              <Text style={{ fontSize: 40 }}>{crop.icon}</Text>
              <Text style={{ marginTop: 8, fontSize: 20, fontWeight: 'bold' }}>{crop.name}</Text>
            </TouchableOpacity>
          ))}
        </View>
      </ScrollView>
    </>
  );
  const renderVarietyList = () => (
    <ScrollView style={{ maxHeight: 300 }}>
      {varietyList.map((varietyPair, idx) => {
        const [crop, variety] = varietyPair.split(' | ');
        return (
          <TouchableOpacity key={idx} style={styles.categoryItem} onPress={() => handleVarietySelect(varietyPair)}>
            <Text>
              <Text style={{ color: '#4CAF50', fontWeight: 'bold', fontSize: 20 }}>{crop}</Text>
              <Text style={{ fontSize: 20 }}> | {variety}</Text>
            </Text>
          </TouchableOpacity>
        );
      })}
      <TouchableOpacity onPress={() => { setSelectedCrop(null); setSearchText(''); setVarietyList([]); }}>
        <Text style={{ color: '#4A90E2', marginTop: 16, textAlign: 'center', fontSize: 18 }}>Ïù∏Í∏∞ÏûëÎ¨ºÎ°ú ÎèåÏïÑÍ∞ÄÍ∏∞</Text>
      </TouchableOpacity>
    </ScrollView>
  );

  // MarketPriceScreen ÏûëÎ¨ºÏ∂îÍ∞Ä Î™®Îã¨ ÏôÑÏ†Ñ ÎèôÏùºÌïòÍ≤å Î≥µÏ†ú
  const renderCropModal = () => (
    <Modal visible={modalVisible} animationType="slide" transparent onRequestClose={closeModal}>
      <View style={styles.modalContainer}>
        <View style={styles.modalContent}>
          {renderModalHeader()}
          {/* Í≤ÄÏÉâÏ∞Ω */}
          <TextInput
            style={[styles.input, { fontSize: 20 }]}
            placeholder="ÏûëÎ¨º Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî"
            value={searchText}
            onChangeText={setSearchText}
          />
          {/* ÏßÅÏ†ë Ï∂îÍ∞ÄÌïòÍ∏∞ Î≤ÑÌäº */}
          <TouchableOpacity 
            style={{ backgroundColor: '#4CAF50', borderRadius: 10, paddingVertical: 14, marginVertical: 10 }}
            onPress={handleDirectAdd}
          >
            <Text style={{ color: '#fff', fontSize: 18, fontWeight: 'bold', textAlign: 'center' }}>ÏßÅÏ†ë Ï∂îÍ∞ÄÌïòÍ∏∞</Text>
          </TouchableOpacity>
          {/* Ïù∏Í∏∞ÏûëÎ¨º or Í≤ÄÏÉâ Í≤∞Í≥º */}
          {varietyList.length === 0 && !selectedCrop ? (
            renderPopularCrops()
          ) : (
            renderVarietyList()
          )}
          {/* Ï∑®ÏÜå Î≤ÑÌäº */}
          <TouchableOpacity style={[styles.modalButton, styles.cancelButton]} onPress={closeModal}>
            <Text style={[styles.modalButtonText, { fontSize: 20 }]}>Îã´Í∏∞</Text>
          </TouchableOpacity>
        </View>
      </View>
    </Modal>
  );

  // Îì±Î°ù Î≤ÑÌäº ÌÅ¥Î¶≠ Ïãú Ï†ÄÏû•
  const handleSave = async () => {
    try {
        if (!selectedDate || !selectedVariety || !content) {
            Alert.alert('ÏïåÎ¶º', 'Î™®Îì† Ìï≠Î™©ÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.');
            return;
        }
        // phone Í∞íÏù¥ ÏóÜÏúºÎ©¥ Ï†ÄÏû• ÏãúÎèÑÌïòÏßÄ ÏïäÏùå
        if (!phoneState) {
            Alert.alert('Ïò§Î•ò', 'ÏÇ¨Ïö©Ïûê Ï†ÑÌôîÎ≤àÌò∏ Ï†ïÎ≥¥Í∞Ä ÏóÜÏäµÎãàÎã§.');
            return;
        }
        console.log('Ï†ÄÏû• ÏãúÎèÑÌïòÎäî phone Í∞í:', phoneState);
        const API_URL = 'http://192.168.35.144:3000';
        const response = await fetch(`${API_URL}/diary/create`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            diary_date: selectedDate.toISOString(),
            crop_type: selectedVariety,
            content: content,
            user_phone: phoneState // Î∞òÎìúÏãú Ìè¨Ìï®
          })
        });
        const result = await response.json();
        if (response.ok) {
          Alert.alert('ÏïåÎ¶º', 'ÏòÅÎÜçÏùºÏßÄÍ∞Ä Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§.');
          navigation.goBack();
        } else {
          Alert.alert('Ïò§Î•ò', result.error || 'ÏòÅÎÜçÏùºÏßÄ Ï†ÄÏû•Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
        }
    } catch (e) {
        console.error('ÏòÅÎÜçÏùºÏßÄ Ï†ÄÏû• Ïã§Ìå®:', e);
        Alert.alert('Ïò§Î•ò', 'ÏòÅÎÜçÏùºÏßÄ Ï†ÄÏû•Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
    }
  };

  // ÏßÅÏ†ë Ï∂îÍ∞ÄÌïòÍ∏∞ Î≤ÑÌäº Ìï∏Îì§Îü¨
  const handleDirectAdd = () => {
    if (!searchText.trim()) {
      Alert.alert('ÏûÖÎ†• Ïò§Î•ò', 'ÏûëÎ¨º Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.');
      return;
    }
    setSelectedVariety(`${searchText} | ÏßÅÏ†ë Ï∂îÍ∞Ä`);
    setModalVisible(false);
  };

  return (
    <ScrollView contentContainerStyle={{padding:24, backgroundColor:'#fff', flexGrow:1}}>
      {renderHeader()}
      {renderCalendar()}
      {renderCalendarModal()}
      {renderCropModal()}
      <View style={{height:18}} />
      <Text style={{fontSize:22, fontWeight:'bold', marginBottom:6}}>Ïñ¥Îñ§ ÏûëÎ¨ºÏùò ÏùºÏßÄÏù∏Í∞ÄÏöî?</Text>
      <TouchableOpacity onPress={openModal} style={{borderWidth:1, borderColor:'#bbb', borderRadius:8, padding:12, marginBottom:24, flexDirection:'row', justifyContent:'space-between', alignItems:'center'}}>
        {selectedVariety ? (
          (() => {
            const [crop, variety] = selectedVariety.split(' | ');
            return (
              <View style={{flex:1, flexDirection:'row', justifyContent:'space-between', alignItems:'center'}}>
                <Text style={{fontSize:18}}>
                  <Text style={{color:'#4CAF50', fontWeight:'bold'}}>{crop}</Text>
                  <Text> | {variety}</Text>
                </Text>
                <TouchableOpacity 
                  onPress={(e) => {
                    e.stopPropagation();
                    setSelectedVariety(null);
                  }}
                  style={{padding:4}}
                >
                  <Text style={{fontSize:20, color:'#666'}}>‚úï</Text>
                </TouchableOpacity>
              </View>
            );
          })()
        ) : (
          <Text style={{fontSize:16}}>+ ÏûëÎ¨º Ï∂îÍ∞Ä</Text>
        )}
      </TouchableOpacity>
      <View style={{height:18}} />
      <Text style={{fontSize:22, fontWeight:'bold', marginBottom:6}}>Ïñ¥Îñ§ ÏûëÏóÖÏùÑ ÌïòÏÖ®ÎÇòÏöî?</Text>
      <TextInput 
        style={{borderWidth:1, borderColor:'#bbb', borderRadius:8, padding:12, minHeight:120, fontSize:16, marginBottom:16, marginTop:8}} 
        placeholder={'ÏûëÏóÖÌïú ÎÇ¥Ïö©ÏùÑ Ï†ÅÏñ¥Î≥¥ÏÑ∏Ïöî.\nÏòàÏãú) Î≥µÏà≠ÏïÑ ÏàòÌôï, ÎπÑÎ£å ÏÇ¥Ìè¨'} 
        value={content} 
        onChangeText={setContent} 
        multiline
      />
      <TouchableOpacity style={{backgroundColor:'#22c55e', borderRadius:12, paddingVertical:14, alignItems:'center'}} onPress={handleSave}>
        <Text style={{color:'#fff', fontWeight:'bold', fontSize:18}}>{editMode ? 'ÏàòÏ†ïÌïòÍ∏∞' : 'Îì±Î°ù'}</Text>
      </TouchableOpacity>
    </ScrollView>
  );
} 